<div class="h-full">
	@if (isLoading()) {
	} @else {
		<form [formGroup]="form" (submit)="$event.preventDefault()">
			<p-stepper #dialogForm [(value)]="currentStep" [linear]="true">
				<p-step-list>
					<p-step [disabled]="!isViewMode()" [value]="1">Datos de la cobertura</p-step>
					<p-step [disabled]="!isViewMode()" [value]="2">Cargar Datos</p-step>
				</p-step-list>

				<p-step-panels>
					<p-step-panel [value]="1">
						<ng-template #content let-activateCallback="activateCallback">
							<div class="flex flex-col gap-2">
								<div class="grid grid-cols-1 gap-2 md:grid-cols-2">
									<app-input-text
										label="Nombre de la cobertura"
										placeholder="Ingrese el nombre de la cobertura"
										name="name"
										[control]="controls['name']"
									></app-input-text>

									<div>
										<label class="block font-medium mb-2" for="typeGeom">Tipo</label>
										<p-select
											inputId="typeGeom"
											placeholder="Seleccionar"
											formControlName="typeGeom"
											[options]="geomTypes"
											appendTo="body"
											class="w-full"
											panelStyleClass="w-full"
											[readonly]="!!currentItem().typeGeom"
										>
										</p-select>
										<app-input-error [control]="controls['typeGeom']"></app-input-error>
									</div>

									<label class="block font-medium mb-2" for="isPublic">
										<p-checkbox formControlName="isPublic" inputId="isPublic" [binary]="true" />
										Cobertura Pública
									</label>
									<label class="block font-medium mb-2" for="allowDownload">
										<p-checkbox formControlName="allowDownload" inputId="allowDownload" [binary]="true" />
										Permitir Descarga
									</label>

									<app-input-text
										label="Frecuencia de actualización"
										placeholder="Ingrese la frecuencia"
										name="updateFrequency']"
										[control]="controls['updateFrequency']"
									></app-input-text>

									<div>
										<label class="block font-medium mb-2" for="contentDate">Fecha de contenido</label>
										<p-datepicker
											placeholder="Seleccionar fecha"
											formControlName="contentDate"
											styleClass="w-full"
											appendTo="body"
											inputId="contentDate"
											[readonlyInput]="true"
											[showIcon]="true"
										/>
										<app-input-error [control]="controls['contentDate']"></app-input-error>
									</div>

									<app-input-text
										type="textarea"
										[maxLength]="300"
										label="Descripción de la cobertura"
										class="md:col-span-2"
										placeholder="Ingrese al descripción"
										name="description"
										[control]="controls['description']"
									></app-input-text>
								</div>
							</div>

							<div class="flex pt-6 justify-end">
								@if (isViewMode()) {
									<p-button
										label="Siguiente"
										icon="pi pi-arrow-right"
										iconPos="right"
										(onClick)="activateCallback(2)"
									/>
								} @else {
									<p-button
										[disabled]="form.invalid"
										label="Guardar y Siguiente"
										icon="pi pi-arrow-right"
										iconPos="right"
										(onClick)="onSubmit()"
									/>
								}
							</div>
						</ng-template>
					</p-step-panel>

					<p-step-panel [value]="2">
						<ng-template #content let-activateCallback="activateCallback">
							<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">
								<p-panel
									class="md:col-span-2 lg:col-span-3"
									toggler="header"
									header="Cargar datos de la cobertura"
									[toggleable]="true"
								>
									@if (showUpload()) {
										@if (currentItem().typeGeom == 'Raster') {
											<small>Solo se admiten imágenes .tiff.</small><br />
											<p-fileUpload
												name="demo[]"
												[customUpload]="true"
												(uploadHandler)="myUploaderRaster($event)"
												accept=".tif"
												chooseLabel="Seleccionar archivo tif"
												uploadLabel="Subir archivo"
												cancelLabel="Cancelar"
											>
												<ng-template pTemplate="content">
													@if (uploadedFiles.length) {
														<ul>
															@for (file of uploadedFiles; track file.name) {
																<li>{{ file.name }} - {{ file.size }} bytes</li>
															}
														</ul>
													}
												</ng-template>
											</p-fileUpload>
										} @else {
											<small>Cargar archivo shape del límite de la región</small> <br />

											<p-fileupload
												[disabled]="isViewMode()"
												name="file"
												accept=".zip"
												maxFileSize="2_000_000"
												mode="advanced"
												chooseLabel="Seleccionar"
												uploadLabel="Subir"
												cancelLabel="Cancelar"
												[customUpload]="true"
												(uploadHandler)="uploadHandler($event)"
											>
												<ng-template pTemplate="empty">
													<small class="font-bold">
														Asegúrese de que el comprimido contenga los archivos .dbf .shp y .shx
													</small>
												</ng-template>
											</p-fileupload>
										}
									} @else {
										<div class="flex justify-center">
											<app-loader [message]="uploadMessage()"> </app-loader>
										</div>
									}
								</p-panel>

								<div class="col-span-1 md:col-span-2 lg:col-span-1 flex flex-col gap-2">
									<p-panel toggler="header" header="Estilos SLD" [toggleable]="true">
										<div>
											<label class="block font-medium mb-2" for="idStyle">
												Seleccione el Estilo SLD correspondiente para la Cobertura Geográfica
											</label>
											<p-select
												[filter]="true"
												filterBy="id,name"
												inputId="idStyle"
												placeholder="Seleccionar"
												[disabled]="isViewMode()"
												[options]="styles"
												[showClear]="true"
												(onChange)="onStyleChange()"
												[(ngModel)]="selectedStyle"
												[ngModelOptions]="{ standalone: true }"
												optionLabel="name"
												appendTo="body"
												class="w-full"
												panelStyleClass="w-full"
											>
											</p-select>
										</div>
										<div class="w-full mt-2" appPermission [resource]="styleResource" [permission]="'canCreate'">
											<p-button
												[disabled]="isViewMode()"
												type="button"
												label="Agregar nuevo estilo"
												icon="pi pi-plus"
												iconPos="right"
												styleClass="w-full"
												(onClick)="createStyle()"
											/>
										</div>
									</p-panel>
								</div>

								<div
									style="height: 500px"
									class="col-span-1 md:col-span-2"
									leaflet
									[leafletOptions]="mapOptions"
									[leafletLayer]="mapLayer"
									(leafletMapReady)="onMapReady($event)"
								></div>
							</div>

							<div class="flex pt-6 justify-between">
								<p-button
									severity="secondary"
									label="Atras"
									icon="pi pi-arrow-left"
									iconPos="left"
									(onClick)="activateCallback(1)"
								/>

								@if (isViewMode()) {
									<p-button (onClick)="closeForm()" label="Cerrar" icon="pi pi-times" iconPos="right" type="button" />
								} @else {
									<p-button
										[disabled]="form.invalid"
										label="Guardar"
										icon="pi pi-save"
										iconPos="right"
										type="button"
										(onClick)="onSubmit()"
									/>
								}
							</div>
						</ng-template>
					</p-step-panel>
				</p-step-panels>
			</p-stepper>
		</form>
	}
</div>
